<center>
  <!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Flipbook PDF – Proyecto Roleplay</title>
<style>
  :root{
    --btn-bg: rgba(0,0,0,.35);
    --btn-bg-hover: rgba(0,0,0,.55);
    --btn-border: rgba(255,255,255,.15);
    --btn-text: #e9eef3;
    --fade: 0.35s; /* duración del crossfade */
  }
  html, body { height: 100%; margin: 0; background: transparent; overflow: hidden; }
  .wrap { position: relative; width: 100%; height: 100%; }
  .stage { position: absolute; inset: 0; }
  .page-shell { position: absolute; inset: 0; }

  /* Capas A/B para crossfade */
  .layer { position: absolute; inset: 0; }
  canvas {
    position: absolute;
    background: transparent;
    box-shadow: none;      /* sin sombra */
    border-radius: 12px;
    display: block;
    opacity: 0;
    transition: opacity var(--fade) ease, transform .2s ease;
    will-change: opacity, transform;
    cursor: zoom-in; /* cambia a zoom-out cuando esté ampliado */
  }
  .ann-layer {
    position: absolute;
    overflow: hidden;
    pointer-events: none;
    opacity: 0;
    transition: opacity var(--fade) ease, transform .2s ease;
    will-change: opacity, transform;
  }
  .ann-link {
    position: absolute;
    pointer-events: auto;
    display: block;
    text-decoration: none;
    outline: none;
  }

  .nav { position: absolute; inset: 0; pointer-events: none; }
  .nav-btn {
    position: absolute;
    width: 46px; height: 76px; border-radius: 14px;
    border: 1px solid var(--btn-border);
    background: var(--btn-bg); color: var(--btn-text);
    display: grid; place-items: center; font-size: 22px;
    cursor: pointer; pointer-events: auto; user-select: none;
    backdrop-filter: blur(6px);
    transition: background .2s ease, transform .12s ease, opacity .2s ease;
  }
  .nav-btn:hover { background: var(--btn-bg-hover); }
  .nav-btn:active { transform: scale(.98); }
  .nav-btn[disabled] { opacity: .4; cursor: not-allowed; }

  .pager {
    position: absolute; bottom: 12px; left: 50%;
    transform: translateX(-50%);
    background: rgba(0,0,0,.4); color: #fff;
    padding: 6px 10px; font: 600 12px/1 system-ui,-apple-system,Segoe UI,Roboto;
    border-radius: 999px; border: 1px solid var(--btn-border);
    backdrop-filter: blur(6px);
  }

  /* Botón pantalla completa */
  .tool-btn {
    position: absolute; top: 12px; right: 12px;
    width: 42px; height: 42px; border-radius: 10px;
    border: 1px solid var(--btn-border);
    background: var(--btn-bg); color: var(--btn-text);
    display: grid; place-items: center; font-size: 18px;
    cursor: pointer; user-select: none; z-index: 5;
    backdrop-filter: blur(6px);
    transition: background .2s ease, transform .12s ease;
  }
  .tool-btn:hover { background: var(--btn-bg-hover); }
  .tool-btn:active { transform: scale(.98); }
</style>
</head>
<body>
  <div class="wrap" id="viewerRoot">
    <div class="stage">
      <div class="page-shell" id="page-shell">
        <!-- Capa A -->
        <div class="layer" id="layerA">
          <canvas id="canvasA"></canvas>
          <div id="annA" class="ann-layer"></div>
        </div>
        <!-- Capa B -->
        <div class="layer" id="layerB">
          <canvas id="canvasB"></canvas>
          <div id="annB" class="ann-layer"></div>
        </div>
      </div>
    </div>

    <!-- Controles -->
    <div class="nav" aria-label="Navegación por páginas">
      <button id="btn-prev" class="nav-btn" title="Anterior (←)">⟵</button>
      <button id="btn-next" class="nav-btn" title="Siguiente (→)">⟶</button>
      <div id="pager" class="pager">– / –</div>
    </div>

    <!-- Pantalla completa -->
    <button id="btn-full" class="tool-btn" title="Pantalla completa">⛶</button>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>
    const PDF_URL = "https://docs.google.com/document/d/1g32QTFlV5Tk4Pr1PQQIwmlXEyaFr0u-Jh-F-Z47CMqc/export?format=pdf";

    let pdfDoc = null, currentPage = 1, active = 'A', animating = false;
    let zoomed = false, Z = 1.6; // factor de zoom con doble clic

    const viewerRoot = document.getElementById('viewerRoot');
    const pageShell = document.getElementById('page-shell');

    const canvasA = document.getElementById('canvasA');
    const canvasB = document.getElementById('canvasB');
    const ctxA = canvasA.getContext('2d', { alpha: true });
    const ctxB = canvasB.getContext('2d', { alpha: true });

    const annA = document.getElementById('annA');
    const annB = document.getElementById('annB');

    const btnPrev = document.getElementById('btn-prev');
    const btnNext = document.getElementById('btn-next');
    const pager  = document.getElementById('pager');
    const btnFull = document.getElementById('btn-full');

    pdfjsLib.GlobalWorkerOptions.workerSrc =
      "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

    function getActiveElems() {
      const isA = active === 'A';
      return {
        canvas: isA ? canvasA : canvasB,
        ann:    isA ? annA    : annB
      };
    }

    function updatePager() {
      pager.textContent = `${currentPage} / ${pdfDoc ? pdfDoc.numPages : '–'}`;
      if (!pdfDoc) { btnPrev.disabled = true; btnNext.disabled = true; return; }
      // Primera página: ocultar prev; resto visible
      btnPrev.style.display = (currentPage === 1) ? 'none' : 'grid';
      btnNext.style.display = 'grid';
      btnPrev.disabled = currentPage <= 1;
      btnNext.disabled = currentPage >= pdfDoc.numPages;
    }

    function clearLayer(annLayer) {
      while (annLayer.firstChild) annLayer.removeChild(annLayer.firstChild);
    }

    async function resolveDestToPageNumber(dest) {
      try {
        let d = dest;
        if (typeof d === 'string') d = await pdfDoc.getDestination(d);
        if (!d || !d[0]) return null;
        const pageIndex = await pdfDoc.getPageIndex(d[0]);
        return pageIndex + 1;
      } catch { return null; }
    }

    function layoutForViewport(vp1) {
      const cw = pageShell.clientWidth;
      const ch = pageShell.clientHeight;
      const scale = Math.min(cw / vp1.width, ch / vp1.height);
      const displayW = Math.floor(vp1.width * scale);
      const displayH = Math.floor(vp1.height * scale);
      const left = Math.floor((cw - displayW) / 2);
      const top  = Math.floor((ch - displayH) / 2);
      return { scale, displayW, displayH, left, top };
    }

    function positionNav(layout) {
      const gap = 16, bw = 46, bh = 76;
      const centerY = layout.top + (layout.displayH - bh) / 2;
      btnPrev.style.left = Math.max(8, layout.left - bw - gap) + 'px';
      btnPrev.style.top  = Math.max(8, centerY) + 'px';
      btnNext.style.left = (layout.left + layout.displayW + gap) + 'px';
      btnNext.style.top  = Math.max(8, centerY) + 'px';
    }

    async function renderAnnotationsInto(annLayer, page, viewport, layout) {
      clearLayer(annLayer);
      annLayer.style.left = layout.left + 'px';
      annLayer.style.top  = layout.top  + 'px';
      annLayer.style.width  = layout.displayW + 'px';
      annLayer.style.height = layout.displayH + 'px';

      const annotations = await page.getAnnotations({ intent: 'display' });
      const f = layout.displayW / viewport.width;

      annotations.forEach((a) => {
        if (a.subtype !== 'Link' || !a.rect) return;
        const rect = pdfjsLib.Util.normalizeRect(a.rect);
        const vRect = viewport.convertToViewportRectangle(rect);
        const [x1, y1, x2, y2] = vRect;

        const link = document.createElement('a');
        link.className = 'ann-link';
        link.style.left   = (Math.min(x1, x2) * f) + 'px';
        link.style.top    = (Math.min(y1, y2) * f) + 'px';
        link.style.width  = (Math.abs(x1 - x2) * f) + 'px';
        link.style.height = (Math.abs(y1 - y2) * f) + 'px';
        link.tabIndex = 0;

        if (a.url || a.unsafeUrl) {
          link.href = a.url || a.unsafeUrl; link.target = '_blank'; link.rel = 'noopener noreferrer';
        } else if (a.dest) {
          link.href = 'javascript:void(0)';
          link.addEventListener('click', async (e) => {
            e.preventDefault();
            const pageNum = await resolveDestToPageNumber(a.dest);
            if (pageNum) showPage(pageNum);
          });
          link.addEventListener('keydown', async (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
              e.preventDefault();
              const pageNum = await resolveDestToPageNumber(a.dest);
              if (pageNum) showPage(pageNum);
            }
          });
        } else return;

        annLayer.appendChild(link);
      });
    }

    // Render en capa 'target' (A o B) y crossfade
    async function renderToLayer(target, pageNumber) {
      const isA = target === 'A';
      const canvas = isA ? canvasA : canvasB;
      const ctx    = isA ? ctxA    : ctxB;
      const ann    = isA ? annA    : annB;

      const page = await pdfDoc.getPage(pageNumber);
      const vp1 = page.getViewport({ scale: 1 });
      const layout = layoutForViewport(vp1);
      const viewport = page.getViewport({ scale: layout.scale });

      const dpr = 1;
      canvas.width  = Math.max(1, Math.floor(viewport.width  * dpr));
      canvas.height = Math.max(1, Math.floor(viewport.height * dpr));
      canvas.style.width  = layout.displayW + 'px';
      canvas.style.height = layout.displayH + 'px';
      canvas.style.left   = layout.left + 'px';
      canvas.style.top    = layout.top  + 'px';

      // Reset transform al cambiar de página
      canvas.style.transform = 'none';
      ann.style.transform = 'none';
      canvas.style.cursor = 'zoom-in';
      zoomed = false;

      await page.render({ canvasContext: ctx, viewport }).promise;
      await renderAnnotationsInto(ann, page, viewport, layout);

      positionNav(layout);
      updatePager();

      // Crossfade
      const otherCanvas = isA ? canvasB : canvasA;
      const otherAnn    = isA ? annB    : annA;
      requestAnimationFrame(() => {
        canvas.style.opacity = 1; ann.style.opacity = 1;
        otherCanvas.style.opacity = 0; otherAnn.style.opacity = 0;
      });
      active = target;
    }

    async function showPage(n) {
      if (!pdfDoc || animating) return;
      const clamped = Math.min(Math.max(1, n), pdfDoc.numPages);
      if (clamped === currentPage) return;
      animating = true;
      currentPage = clamped;
      const target = (active === 'A') ? 'B' : 'A';
      await renderToLayer(target, currentPage);
      setTimeout(() => { animating = false; }, 60);
    }

    // Doble clic para zoom (toggle). Zoom hacia el punto donde se hace doble clic.
    function toggleZoomAt(event) {
      const { canvas, ann } = getActiveElems();
      const rect = canvas.getBoundingClientRect();
      const x = event.clientX - rect.left;
      const y = event.clientY - rect.top;

      if (!zoomed) {
        const origin = `${x}px ${y}px`;
        canvas.style.transformOrigin = origin;
        ann.style.transformOrigin = origin;
        canvas.style.transform = `scale(${Z})`;
        ann.style.transform = `scale(${Z})`;
        canvas.style.cursor = 'zoom-out';
        zoomed = true;
      } else {
        canvas.style.transform = 'none';
        ann.style.transform = 'none';
        canvas.style.cursor = 'zoom-in';
        zoomed = false;
      }
    }

    // Pantalla completa
    function toggleFullscreen() {
      const el = viewerRoot;
      if (!document.fullscreenElement) {
        el.requestFullscreen?.();
      } else {
        document.exitFullscreen?.();
      }
    }

    // Carga inicial
    pdfjsLib.getDocument(PDF_URL).promise.then(async pdf => {
      pdfDoc = pdf;
      await renderToLayer('A', 1);
      canvasA.style.opacity = 1; annA.style.opacity = 1;
    }).catch(err => {
      console.error('Error cargando PDF:', err);
      pager.textContent = 'No se pudo cargar el PDF';
      btnPrev.disabled = true; btnNext.disabled = true;
    });

    // Controles
    btnPrev.onclick = () => showPage(currentPage - 1);
    btnNext.onclick = () => showPage(currentPage + 1);
    window.onkeydown = (e) => {
      if (!pdfDoc) return;
      if (e.key === 'ArrowLeft' && currentPage > 1) showPage(currentPage - 1);
      if (e.key === 'ArrowRight') showPage(currentPage + 1);
      if (e.key === 'f' || e.key === 'F') toggleFullscreen();
    };

    // Doble clic zoom sobre cualquiera de las capas
    canvasA.addEventListener('dblclick', toggleZoomAt);
    canvasB.addEventListener('dblclick', toggleZoomAt);

    // Botón pantalla completa
    btnFull.onclick = toggleFullscreen;

    // Redibujar al cambiar tamaño (mantiene página; resetea zoom para coherencia)
    let resizeTimer = null;
    window.addEventListener('resize', () => {
      if (!pdfDoc) return;
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(async () => {
        zoomed = false;
        const { canvas, ann } = getActiveElems();
        canvas.style.transform = 'none';
        ann.style.transform = 'none';
        await renderToLayer(active, currentPage);
      }, 120);
    });
  </script>
</body>
</html>

</center>